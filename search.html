
<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>S√∂k ‚Äì StoreShare</title>
    <link rel="stylesheet" href="./style.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body>

<header class="fixed-header" role="banner">
  <div class="fixed-header-inner">
    <img class="fixed-logo" 
         src="./assets/storeshare-logo-132.png" 
         srcset="./assets/storeshare-logo-132.png 1x, ./assets/storeshare-logo-264.png 2x, ./assets/storeshare-logo-396.png 3x"
         width="56" height="56" alt="StoreShare">
    <span class="fixed-brand">StoreShare</span>
    <nav class="auth-links"></nav>
  </div>
</header>
    <div class="container" style="max-width:1200px">
  <!-- Filters (S√∂k) -->
  <section class="glass" style="padding:16px; margin: 0 0 12px 0" id="filtersSection">
    <h3 style="margin-top:0">Filtrera</h3>
    <div class="field">
      <label>Plats</label>
      <div class="search-bar"><input id="q" placeholder="Adress eller ort i Sverige‚Ä¶"/></div>
      <div id="ac" class="ac-wrap"></div>
    </div>
    <div class="row" style="margin-top:8px; gap:8px">
      <button id="pick" class="chip">V√§lj p√• karta‚Ä¶</button>
      <span id="centerChip" class="chip" style="display:none">Satt</span>
    </div>
    <div class="field"><label>Radie (km)</label><input type="number" id="radius" placeholder="0"/></div>
    <div class="field"><label><input type="checkbox" id="heated"/> Uppv√§rmt</label></div>
    <div class="field"><label><input type="checkbox" id="dehum"/> Avfuktare</label></div>
    <div class="two-col" style="grid-template-columns:1fr 1fr; gap:10px;">
      <div class="field"><label>Min yta (m¬≤)</label><input type="number" id="minSize" placeholder="0"/></div>
      <div class="field"><label>Max pris (kr/m√•n)</label><input type="number" id="maxPrice" placeholder="t.ex. 800"/></div>
    </div>
    <div class="row" style="margin-top:8px"><button id="clear" class="btn ghost">Rensa filter</button></div>
    <div class="quick-jump">
      <a href="#mapSection" class="chip">Hoppa till karta</a>
      <a href="#resultsSection" class="chip">Hoppa till resultat</a>
    </div>
  </section>

  <!-- Map section -->
  <section style="margin: 0 0 12px 0" id="mapSection">
    <h3 style="margin:0 0 8px 0">Karta</h3>
    <div id="map" class="map-vertical"></div>
  </section>

  <!-- Results section -->
  <section id="resultsSection">
    <div class="row" style="justify-content:space-between; margin-bottom:12px">
      <h2 style="margin:0">S√∂kresultat</h2>
      <div style="color:#666"><span id="count">0</span> tr√§ffar</div>
    </div>
    <div id="cards" class="cards"></div>
  </section>


      </div>
    </div>
    <script>
      // Show logo only when user scrolls back to top small region
      const cornerLogo = document.getElementById('cornerLogo')
      window.addEventListener('scroll', () => {
        const y = window.scrollY || document.documentElement.scrollTop
        if (y < 40) cornerLogo.classList.remove('hide'); else cornerLogo.classList.add('hide')
      }, { passive:true })

      // Seed + Load
      function seedListings(){ return [
        {id:'1',title:'Uppv√§rmt f√∂rr√•d med avfuktare',description:'Perfekt f√∂r elektronik och m√∂bler. Ligger n√§ra centrum.',pricePerMonth:600,sizeSqm:6,heated:true,dehumidifier:true,photos:['./assets/garage1.avif'],location:{address:'Rosenlundsgatan ‚Ä¢ G√∂teborg',lat:57.7089,lng:11.9746}},
        {id:'2',title:'K√§llarf√∂rr√•d i villa',description:'Svalt √•ret runt. Inte uppv√§rmt.',pricePerMonth:350,sizeSqm:4,heated:false,dehumidifier:false,photos:['./assets/garage2.webp'],location:{address:'Sveav√§gen ‚Ä¢ Stockholm',lat:59.3293,lng:18.0686}}
      ]}
      function loadUserListings(){ try{ return JSON.parse(localStorage.getItem('storeshare:demo:listings')||'[]') }catch(e){ return [] } }
      function loadListings(){ return seedListings().concat(loadUserListings()) }

      // Geocode helpers (same as index)
      const SE_BBOX = { minLon: 10.0, minLat: 55.0, maxLon: 24.5, maxLat: 69.5 }
      const VIEWBOX = `${SE_BBOX.minLon},${SE_BBOX.maxLat},${SE_BBOX.maxLon},${SE_BBOX.minLat}`
      async function timeoutFetch(url, ms=3000){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),ms); try{ return await fetch(url,{signal:ctrl.signal,headers:{'Accept-Language':'sv'}})} finally{clearTimeout(t)}}
      function labelFromPhoton(p){ const parts=[p.name,p.city||p.locality||p.county,p.state].filter(Boolean); return parts.join(' ‚Ä¢ ') }
      async function suggestAddressesSE(q){
        q=(q||'').trim(); if(!q) return []; const out=[]; const bbox=`${SE_BBOX.minLon},${SE_BBOX.minLat},${SE_BBOX.maxLon},${SE_BBOX.maxLat}`
        try{ const url=`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&lang=sv&limit=8&bbox=${bbox}`; const res=await timeoutFetch(url,2500); if(res.ok){ const data=await res.json(); (data.features||[]).forEach(f=>{const p=f.properties||{}; const [lng,lat]=f.geometry?.coordinates||[]; if(lat&&lng) out.push({label:labelFromPhoton(p),lat,lng}) }) } }catch(e){}
        try{ const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&countrycodes=se&bounded=1&viewbox=${VIEWBOX}&q=${encodeURIComponent(q)}`; const res=await timeoutFetch(url,2500); if(res.ok){ const data=await res.json(); (data||[]).forEach(it=>{ if(it?.lat&&it?.lon){ const a=it.address||{}; const title=it.display_name?.split(',')[0]||a.road||a.suburb||a.village||a.town||a.city||'Plats'; const city=a.city||a.town||a.village||a.municipality||a.county||''; const label=city?`${title} ‚Ä¢ ${city}`:title; out.push({label,lat:parseFloat(it.lat),lng:parseFloat(it.lon)}) } }) } }catch(e){}
        try{ const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=sv&format=json&country=SE`; const res=await timeoutFetch(url,2000); if(res.ok){ const data=await res.json(); (data.results||[]).forEach(r=> out.push({label:[r.name,r.admin1].filter(Boolean).join(' ‚Ä¢ '), lat:r.latitude, lng:r.longitude})) } }catch(e){}
        out.push({ pickOnMap:true, label:'V√§lj p√• karta‚Ä¶' })
        const seen=new Set(); return out.filter(x=>{ const k=(x.pickOnMap?'pick':'')+'|'+x.label; if(seen.has(k)) return false; seen.add(k); return true })
      }

      // Map init + filtering
      const map = L.map('map').setView([59.334591, 18.06324], 11)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map)

      const cards = document.getElementById('cards')
      const q = document.getElementById('q')
      const acWrap = document.getElementById('ac')
      const centerChip = document.getElementById('centerChip')
      const radius = document.getElementById('radius')
      const heated = document.getElementById('heated')
      const dehum = document.getElementById('dehum')
      const minSize = document.getElementById('minSize')
      const maxPrice = document.getElementById('maxPrice')
      const pickBtn = document.getElementById('pick')
      const clearBtn = document.getElementById('clear')

      const params = new URLSearchParams(location.search)
      let center = null
      if(params.get('q')) q.value = params.get('q')
      if(params.get('lat') && params.get('lng')){ center=[parseFloat(params.get('lat')), parseFloat(params.get('lng'))]; map.setView(center,12); centerChip.style.display='inline-block' }

      let markers=[]; const listings=loadListings()
      function toRad(x){ return x*Math.PI/180 }
      function hav(lat1,lon1,lat2,lon2){ const R=6371; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c }
      function render(){
        markers.forEach(m=>map.removeLayer(m)); markers=[]
        const rKm=Number(radius.value||0), minS=Number(minSize.value||0), maxP=Number(maxPrice.value||99999) || 99999
        const fil = listings.filter(l=>{
          if(heated.checked && !l.heated) return false
          if(dehum.checked && !l.dehumidifier) return false
          if(l.sizeSqm < minS) return false
          if(l.pricePerMonth > maxP) return false
          if(center && rKm>0 && l.location?.lat && l.location?.lng){ if(hav(center[0],center[1],l.location.lat,l.location.lng) > rKm) return false }
          return true
        })
        document.getElementById('count').textContent = fil.length
        cards.innerHTML = fil.map(l => `
          <a class="card-link" href="./listing.html?id=${encodeURIComponent(l.id)}">
            <div class="card">
              <img src="${l.photos[0]}" alt="${l.title}"/>
              <div class="card-body">
                <div class="row" style="justify-content:space-between"><strong>${l.title}</strong><span>${l.sizeSqm} m¬≤</span></div>
                <div style="color:#555;margin-top:4px">${l.location.address}</div>
                <div style="margin-top:6px">${l.pricePerMonth} kr/m√•n</div>
              </div>
            </div>
          </a>
        `).join('')
        fil.forEach(l=>{ const m=L.marker([l.location.lat,l.location.lng]).addTo(map); m.bindPopup(`<strong>${l.title}</strong><br>${l.location.address}<br>${l.pricePerMonth} kr/m√•n ‚Ä¢ ${l.sizeSqm} m¬≤`); markers.push(m) })
      }
      ;['input','change'].forEach(ev=>{ radius.addEventListener(ev,render); heated.addEventListener(ev,render); dehum.addEventListener(ev,render); minSize.addEventListener(ev,render); maxPrice.addEventListener(ev,render) })
      clearBtn.addEventListener('click', ()=>{ radius.value=0; heated.checked=false; dehum.checked=false; minSize.value=0; maxPrice.value=''; render() })

      // Autocomplete
      let t=null
      function renderAC(items){
        const list=document.createElement('div'); list.className='ac-list'
        items.forEach(it=>{
          const row=document.createElement('div'); row.className='ac-item'
          row.innerHTML = `<div class="ac-label">${it.label}</div>` + (it.pickOnMap?'<div class="ac-sub">Placera pin p√• karta</div>':'')
          row.onclick = ()=>{
            if(it.pickOnMap){
              alert('Klicka p√• kartan f√∂r att v√§lja centrum.')
              const onClick = (e)=>{ center=[e.latlng.lat,e.latlng.lng]; centerChip.style.display='inline-block'; map.setView(center,12); map.off('click', onClick); render() }
              map.on('click', onClick)
            }else{
              center=[it.lat,it.lng]; centerChip.style.display='inline-block'; map.setView(center,12); render()
            }
            acWrap.innerHTML=''
          }
          list.appendChild(row)
        })
        acWrap.innerHTML=''; acWrap.appendChild(list)
      }
      q.addEventListener('input', (e)=>{ const val=e.target.value.trim(); if(t) clearTimeout(t); if(val.length<2){ acWrap.innerHTML=''; return; } t=setTimeout(async()=>{ renderAC(await suggestAddressesSE(val)) },250) })
      document.addEventListener('click', (e)=>{ if(!acWrap.contains(e.target) && e.target!==q){ acWrap.innerHTML='' } })

      // Pick button
      pickBtn.addEventListener('click', ()=>{
        alert('Klicka p√• kartan f√∂r att v√§lja centrum.')
        const onClick = (e)=>{ center=[e.latlng.lat,e.latlng.lng]; centerChip.style.display='inline-block'; map.setView(center,12); map.off('click', onClick); render() }
        map.on('click', onClick)
      })
      render()
    </script>
      <script src="./app.js"></script>
  
<nav class="bottom-nav">
  <a href="index.html" ><span aria-hidden="true" style="font-size:1.15rem">üß≠</span><span>Start</span></a>
  <a href="search.html" class="active"><span aria-hidden="true" style="font-size:1.15rem">üîé</span><span>S√∂k</span></a>
  <a href="create.html" ><span aria-hidden="true" style="font-size:1.15rem">üè†</span><span>Hyr ut</span></a>
  <a href="profile.html" ><span aria-hidden="true" style="font-size:1.15rem">üë§</span><span>Profil</span></a>
</nav>


<script>
function getSession(){ try{ return JSON.parse(localStorage.getItem('storeshare:session')||'null') }catch(e){ return null } }
function setSession(sess){ if(sess){ localStorage.setItem('storeshare:session', JSON.stringify(sess)) } else { localStorage.removeItem('storeshare:session') } }
function updateAuthUI(){
  const nav = document.querySelector('.auth-links'); if(!nav) return;
  const sess = getSession();
  if(sess){
    nav.innerHTML = `<span class="user-chip" title="${sess.email}">Inloggad som ${sess.name||sess.email}</span>
                     <button class="btn ghost" id="logoutBtn">Logga ut</button>`;
    const btn = nav.querySelector('#logoutBtn');
    if(btn){ btn.addEventListener('click', ()=>{ setSession(null); location.href='./index.html' }) }
  }else{
    nav.innerHTML = `<a class="btn ghost" href="./login.html">Logga in</a>
                     <a class="btn" href="./signup.html">Skapa konto</a>`;
  }
}
document.addEventListener('DOMContentLoaded', updateAuthUI);
// Intercept Hyr ut & Profil if not logged in
document.addEventListener('click', (e)=>{
  const link = e.target.closest('a[href$="create.html"], a[href$="profile.html"]');
  if(!link) return;
  const sess = getSession();
  if(!sess){
    e.preventDefault();
    const url = new URL(link.getAttribute('href'), location.href);
    const ret = encodeURIComponent(url.pathname.split('/').pop());
    location.href = `./login.html?return=${ret}`;
  }
});
</script>


<script>
// Dynamic spacer to avoid bottom-nav covering content
(function(){
  const nav = document.querySelector('.bottom-nav');
  if(!nav) return;
  let spacer = document.getElementById('navSpacer');
  if(!spacer){
    spacer = document.createElement('div');
    spacer.id = 'navSpacer';
    spacer.style.width = '100%';
    spacer.style.height = '0px';
    spacer.style.pointerEvents = 'none';
    document.body.appendChild(spacer);
  }
  function setSpacer(){
    const h = Math.ceil(nav.getBoundingClientRect().height || 0);
    const extra = 24; // breathing room
    spacer.style.height = (h + extra) + 'px';
    document.body.style.paddingBottom = (h + extra) + 'px';
  }
  const ro = new ResizeObserver(setSpacer);
  ro.observe(nav);
  window.addEventListener('orientationchange', setSpacer);
  window.addEventListener('resize', setSpacer);
  window.addEventListener('load', setSpacer);
  setSpacer();
})();
</script>

</body>
</html>
